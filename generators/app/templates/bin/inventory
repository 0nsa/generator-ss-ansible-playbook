#!/usr/bin/env python

"""
$ ENV=dev ansible-playbook -i bin/inventory playbooks/all.yml
$ ENV=dev inventory.py --list
"""

import argparse
import json
import os
import sys

import yaml


CFG_FILENAME = "servers.yml"


def get_parser():
    parser = argparse.ArgumentParser()
    parser.add_argument("--list", action="store_true")
    return parser

def get_cfg_path():
    return os.path.realpath(
        os.path.join(
            os.path.dirname(os.path.abspath(__file__)), "..", CFG_FILENAME))


def read_cfg():
    with open(get_cfg_path()) as r:
        return yaml.load(r)


def conv_inventories(data, env):
    ret = {}
    for role, role_data in data[env].items():
        ret[role] = {
            "hosts": ["{}-{}.{}".format(role, idx, env)
                      for idx in role_data["vms"]],
            "vars": role_data["params"],
        }
    return ret


def get_inventories(args):
    cfg = read_cfg()
    return conv_inventories(cfg, os.environ["ENV"])


def main():
    parser = get_parser()
    args = parser.parse_args()
    if args.list:
        json.dump(get_inventories(args), sys.stdout)


if __name__ == "__main__":
    main()
