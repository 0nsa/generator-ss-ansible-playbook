#!/usr/bin/env python

"""
$ ENV=dev ansible-playbook -i bin/inventory playbooks/all.yml
$ ENV=dev inventory.py --list
"""

import argparse
import json
import os
import sys

import yaml


def get_parser():
    parser = argparse.ArgumentParser()
    parser.add_argument("--list", action="store_true")
    return parser


def get_cfg_yaml_path():
    return os.path.realpath(
        os.path.join(
            os.path.dirname(os.path.abspath(__file__)),
            "..", "cfg.yml"))


def get_servers_yaml_path(cfg):
    return os.path.realpath(
        os.path.join(
            os.path.dirname(os.path.abspath(__file__)),
            "..", cfg["servers_yml_path"]))


def conv_inventories(data, env):
    ret = {}
    for role, role_data in data[env].items():
        ret[role] = {
            "hosts": ["{}-{}.{}".format(role, idx, env)
                      for idx in role_data["hosts"]],
            "vars": role_data["params"],
        }
    return ret


def get_inventories(args):
    with open(get_cfg_yaml_path()) as r:
        cfg = yaml.load(r)
    with open(get_servers_yaml_path(cfg)) as r:
        servers = yaml.load(r)
    return conv_inventories(servers, os.environ["ENV"])


def main():
    parser = get_parser()
    args = parser.parse_args()
    if args.list:
        json.dump(get_inventories(args), sys.stdout)


if __name__ == "__main__":
    main()
